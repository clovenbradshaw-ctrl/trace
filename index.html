<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRACE Badge Generator</title>
  <link rel="icon" type="image/png" href="https://storage.googleapis.com/art_homelessness/android-chrome-192x192.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --badge: 360px;
      --edge: 10px;
      --blue: #3b82f6;
      --green: #10b981;
      --yellow: #f59e0b;
      --red: #ef4444;
      --gray: #e5e7eb;
    }

    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f8fafc;
      color: #334155;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: white;
      border-bottom: 1px solid var(--gray);
    }

    .header-left {
      display: flex;
      flex-direction: column;
    }

    .header-title {
      margin: 0;
      font-size: 1.8rem;
      color: #1e293b;
    }

    .subtitle {
      margin: 0;
      font-size: 0.9rem;
      color: #64748b;
    }

    .main-container {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 2rem;
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Controls Panel with Quadrant Layout */
    .controls-panel {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .quadrant-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 1rem;
      min-height: 500px;
    }

    .quadrant {
      background: #f8fafc;
      border-radius: 8px;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      display: flex;
      flex-direction: column;
    }

    .quadrant.role { 
      border-left: 4px solid #06b6d4; 
      grid-area: 1 / 1;
    }
    .quadrant.data { 
      border-left: 4px solid #22c55e;
      grid-area: 1 / 2;
    }
    .quadrant.method { 
      border-left: 4px solid #f97316;
      grid-area: 2 / 1;
    }
    .quadrant.review { 
      border-left: 4px solid #8b5cf6;
      grid-area: 2 / 2;
    }

    .quadrant-header {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .help-btn {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      font-weight: bold;
      cursor: pointer;
      color: #64748b;
      transition: all 0.2s;
    }
    
    .help-btn:hover {
      background: #e2e8f0;
      color: #475569;
    }

    .quadrant-options {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      flex: 1;
      overflow-y: auto;
    }

    .option-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.35rem;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .option-item:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .option-item.selected {
      background: #eff6ff;
      border-color: var(--blue);
    }

    .option-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .option-label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #1e293b;
    }

    .option-code {
      background: #1e293b;
      color: white;
      padding: 0.125rem 0.35rem;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 1.2rem;
      text-align: center;
    }

    .option-desc {
      font-size: 0.7rem;
      color: #64748b;
      margin-left: 2rem;
    }

    /* AI Models Section */
    .ai-model-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .ai-model-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .ai-model-title {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .refresh-btn {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      color: #64748b;
      transition: all 0.2s;
    }

    .refresh-btn:hover:not(:disabled) {
      background: #e2e8f0;
      color: #475569;
    }
    
    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .model-selector {
      margin-bottom: 0.75rem;
    }

    .model-search {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .search-results {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
    }

    .model-pill {
      padding: 0.5rem 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      display: inline-block;
      margin: 0.25rem;
    }

    .model-pill:hover {
      border-color: var(--blue);
      background: #eff6ff;
    }

    .model-pill.selected {
      background: var(--blue);
      color: white;
      border-color: var(--blue);
    }

    .selected-models {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .selected-models-header {
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .selected-model-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      margin-bottom: 0.5rem;
    }

    .remove-model-btn {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .remove-model-btn:hover {
      background: #fecaca;
    }

    /* Badge Display */
    .badge-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .badge-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .model-name {
      margin-top: 12px;
      font-size: 0.85em;
      color: #666;
      font-style: italic;
      text-align: center;
    }

    .badge {
      width: var(--badge);
      height: var(--badge);
      border-radius: calc(var(--badge) * 0.12);
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 0 var(--edge) #cbd5e0 inset, 0 4px 12px rgba(0,0,0,0.1);
      background: #cbd5e0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .cell {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: calc(var(--edge) * 1.8) calc(var(--edge) * 1.4);
      box-sizing: border-box;
      overflow: hidden;
      margin: calc(var(--edge) / 2);
    }

    .cell:nth-child(1) {
      border-top-left-radius: calc(var(--badge) * 0.12 - var(--edge));
      background: #06b6d4;
      margin-right: calc(var(--edge) / 2);
      margin-bottom: calc(var(--edge) / 2);
    }

    .cell:nth-child(2) {
      border-top-right-radius: calc(var(--badge) * 0.12 - var(--edge));
      background: #22c55e;
      margin-left: calc(var(--edge) / 2);
      margin-bottom: calc(var(--edge) / 2);
    }

    .cell:nth-child(3) {
      border-bottom-left-radius: calc(var(--badge) * 0.12 - var(--edge));
      background: #f97316;
      margin-right: calc(var(--edge) / 2);
      margin-top: calc(var(--edge) / 2);
    }

    .cell:nth-child(4) {
      border-bottom-right-radius: calc(var(--badge) * 0.12 - var(--edge));
      background: #8b5cf6;
      margin-left: calc(var(--edge) / 2);
      margin-top: calc(var(--edge) / 2);
    }

    .cell .code {
      font-weight: 600;
      line-height: 1.1;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      margin-bottom: calc(var(--edge) * 0.8);
      font-size: calc(var(--badge) * 0.12);
    }

    .cell .label {
      line-height: 1.0;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      font-size: calc(var(--badge) * 0.05);
    }

    .badge.grayscale .cell:nth-child(1) { background: #374151; }
    .badge.grayscale .cell:nth-child(2) { background: #6b7280; }
    .badge.grayscale .cell:nth-child(3) { background: #9ca3af; }
    .badge.grayscale .cell:nth-child(4) { background: #d1d5db; }

    .badge.grayscale {
      box-shadow: 0 0 0 var(--edge) #9ca3af inset, 0 4px 12px rgba(0,0,0,0.1);
      background: #9ca3af;
    }

    .badge.hidden-tags .label {
      display: none;
    }

    /* Style Options */
    .style-options {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .style-options label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      color: #64748b;
    }

    /* Citation Section */
    .citation-tabs {
      display: flex;
      border-bottom: 1px solid var(--gray);
      margin-bottom: 0.5rem;
    }

    .citation-tab {
      flex: 1;
      padding: 0.5rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      color: #64748b;
      transition: all 0.2s;
    }

    .citation-tab.active {
      border-bottom: 2px solid var(--blue);
      color: #1e293b;
      font-weight: 600;
    }

    .citation-panel {
      display: none;
      background: #f1f5f9;
      border-radius: 8px;
      padding: 1rem;
      font-family: ui-monospace, SFMono-Regular, monospace;
      font-size: 0.85rem;
      line-height: 1.5;
      color: #334155;
      min-height: 120px;
      white-space: pre-wrap;
    }

    .citation-panel.active {
      display: block;
    }

    .button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button:hover {
      background: #2563eb;
    }

    .button.secondary {
      background: #64748b;
    }

    .button.secondary:hover {
      background: #475569;
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 1rem;
    }

    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      
      .quadrant-grid {
        min-height: 400px;
      }
      
      .badge {
        width: 300px;
        height: 300px;
      }
    }
    
    @media (max-width: 768px) {
      .quadrant-grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, auto);
        min-height: auto;
      }
      
      .quadrant {
        min-height: 120px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <h1 class="header-title">TRACE Badge Generator</h1>
      <p class="subtitle">Generate transparency badges for AI-assisted work</p>
    </div>
  </header>

  <div class="main-container">
    <!-- Left Panel: Controls -->
    <div class="panel controls-panel">
      <!-- TRACE Options Quadrant -->
      <div class="quadrant-grid">
        <div class="quadrant role" id="role-group">
          <div class="quadrant-header">
            Role
          </div>
          <div class="quadrant-options"></div>
        </div>

        <div class="quadrant data" id="data-group">
          <div class="quadrant-header">
            Data
          </div>
          <div class="quadrant-options"></div>
        </div>

        <div class="quadrant method" id="method-group">
          <div class="quadrant-header">
            Method
          </div>
          <div class="quadrant-options"></div>
        </div>

        <div class="quadrant review" id="review-group">
          <div class="quadrant-header">
            Review
          </div>
          <div class="quadrant-options"></div>
        </div>
      </div>

      <!-- AI Models Section -->
      <div class="ai-model-section">
        <div class="ai-model-header">
          <div class="ai-model-title">AI Models Used</div>
          <button class="refresh-btn" onclick="loadAIModels()" title="Reload models">
            🔄 Reload
          </button>
        </div>
        
        <div class="model-selector">
          <input type="text" class="model-search" placeholder="Search AI models (e.g., GPT-4, Claude, Gemini)...">
          <div class="search-results"></div>
        </div>

        <div class="selected-models" id="selected-models-container" style="display: none;">
          <div class="selected-models-header">Selected Models:</div>
          <div id="selected-models-list"></div>
        </div>
      </div>
    </div>

    <!-- Center Panel: Badge -->
    <div class="panel">
      <div class="badge-container">
        <div id="badge-wrapper" class="badge-wrapper">
          <div id="badge" class="badge">
            <div class="cell"><span class="code"></span><span class="label"></span></div>
            <div class="cell"><span class="code"></span><span class="label"></span></div>
            <div class="cell"><span class="code"></span><span class="label"></span></div>
            <div class="cell"><span class="code"></span><span class="label"></span></div>
          </div>
          <div id="model-name" class="model-name"></div>
        </div>

        <div class="style-options">
          <label>
            <input type="checkbox" id="show-tags" checked>
            Show tags on badge
          </label>
          <label>
            <input type="checkbox" id="grayscale-mode">
            Grayscale version
          </label>
        </div>

        <div class="actions">
          <button class="button" onclick="downloadBadge()">📥 Download Badge</button>
          <button class="button secondary" onclick="copyCitation()">📋 Copy Citation</button>
        </div>
      </div>
    </div>

    <!-- Right Panel: Citation -->
    <div class="panel">
      <div class="citation-tabs">
        <button class="citation-tab active" data-tab="formal">Formal</button>
        <button class="citation-tab" data-tab="natural">Natural Language</button>
      </div>
      
      <div class="citation-panel active" id="tab-formal"></div>
      <div class="citation-panel" id="tab-natural"></div>
    </div>
  </div>

  <script>
    const TAGS = {
      role: [
        {code: 'A', label: 'Assist', desc: 'Clean up grammar & style'},
        {code: 'D', label: 'Draft', desc: 'Wrote first draft'},
        {code: 'S', label: 'Synthesis', desc: 'Combined sources'},
        {code: 'N', label: 'Analysis', desc: 'Explained patterns'},
        {code: 'E', label: 'Exploratory', desc: 'Experimental testing'},
        {code: 'C', label: 'Creative', desc: 'Generated new content'}
      ],
      data: [
        {code: 'P', label: 'Public', desc: 'Public or user provided'},
        {code: 'I', label: 'Internal', desc: 'Private sources'},
        {code: 'M', label: 'Model-only', desc: 'No external input', exclusive: true},
        {code: 'U', label: 'Unclear', desc: 'Source unknown', exclusive: true}
      ],
      method: [
        {code: 'R', label: 'Raw', desc: 'First answer', exclusive: true},
        {code: 'G', label: 'Guided', desc: 'Step-by-step prompts'},
        {code: 'W', label: 'Rewriter', desc: 'Transformed text'},
        {code: 'A', label: 'Augmented', desc: 'Used tools'}
      ],
      review: [
        {code: 'U', label: 'Unreviewed', desc: 'Not checked', exclusive: true},
        {code: 'S', label: 'Skimmed', desc: 'Quick read'},
        {code: 'P', label: 'Peer', desc: 'Non-expert review'},
        {code: 'E', label: 'Expert', desc: 'Expert reviewed'},
        {code: 'A', label: 'AI-Check', desc: 'Self-reviewed'}
      ]
    };

    const NL_TEMPLATES = {
      role: {
        'A': {verb: 'clean up', action: 'grammar and style', prep: 'in the text'},
        'D': {verb: 'draft', action: 'initial content'},
        'S': {verb: 'synthesize', action: 'information', prep: 'from multiple sources'},
        'N': {verb: 'analyze', action: 'patterns and data'},
        'E': {verb: 'explore', action: 'possibilities', prep: 'through experimental testing'},
        'C': {verb: 'create', action: 'new content'}
      },
      data: {
        single: {
          'P': 'public sources',
          'I': 'internal/private data',
          'M': 'only the AI model\'s training data',
          'U': 'unclear or unspecified sources'
        },
          combinations: {
            'PI': 'public and internal sources'
          }
      },
      method: {
        'R': {desc: 'with raw output', suffix: '(first response used)'},
        'G': {desc: 'through guided prompting'},
        'W': {desc: 'by rewriting and transforming text'},
        'A': {desc: 'with augmented tools and capabilities'}
      },
      review: {
        single: {
          'U': 'has not been reviewed',
          'S': 'was skimmed quickly',
          'P': 'underwent peer review',
          'E': 'was expert reviewed',
          'A': 'was AI-checked for consistency'
        },
        combinations: {
          'SP': 'was skimmed and peer reviewed',
          'SE': 'was skimmed and expert reviewed',
          'PE': 'underwent peer and expert review',
          'SA': 'was skimmed and AI-checked',
          'SPE': 'was skimmed, peer reviewed, and expert reviewed'
        }
      }
    };

    let selectedModels = [];
    let aiModels = [];

    function setupGroup(groupId) {
      const group = document.getElementById(groupId);
      if (!group) return;

      group.addEventListener('change', () => {
        const inputs = group.querySelectorAll('input');
        const exclusive = [...group.querySelectorAll('input[data-exclusive="true"]')];
        const nonExclusive = [...group.querySelectorAll('input:not([data-exclusive="true"])')];
        const checkedExclusive = exclusive.find(i => i.checked);
        const checkedNonExclusive = nonExclusive.some(i => i.checked);

        if (checkedExclusive) {
          nonExclusive.forEach(i => {
            i.checked = false;
            i.disabled = true;
            i.parentElement.classList.remove('selected');
          });
          exclusive.forEach(i => {
            if (i !== checkedExclusive) {
              i.checked = false;
              i.disabled = true;
              i.parentElement.classList.remove('selected');
            } else {
              i.disabled = false;
            }
          });
        } else if (checkedNonExclusive) {
          exclusive.forEach(i => {
            i.checked = false;
            i.disabled = true;
            i.parentElement.classList.remove('selected');
          });
          nonExclusive.forEach(i => {
            i.disabled = false;
          });
        } else {
          exclusive.forEach(i => { i.disabled = false; });
          nonExclusive.forEach(i => { i.disabled = false; });
        }

        inputs.forEach(i => {
          const label = i.parentElement;
          label.classList.toggle('selected', i.checked);
        });

        updateBadge();
      });
    }

    // Initialize TRACE options with mutual exclusivity rules
    function initializeOptions() {
      Object.entries(TAGS).forEach(([group, tags]) => {
        const container = document.querySelector(`#${group}-group .quadrant-options`);
        container.innerHTML = '';

        tags.forEach(tag => {
          const optionItem = document.createElement('label');
          optionItem.className = 'option-item';
          optionItem.innerHTML = `
            <input type="checkbox"
                   id="${group}-${tag.code}"
                   name="${group}-multi"
                   value="${tag.code}"
                   ${tag.exclusive ? 'data-exclusive="true"' : ''}>
            <div class="option-content">
              <div class="option-label">
                <span class="option-code">${tag.code}</span>
                <span>${tag.label}</span>
              </div>
              <div class="option-desc">${tag.desc}</div>
            </div>
          `;

          container.appendChild(optionItem);
        });
      });

      ['role-group', 'data-group', 'method-group', 'review-group'].forEach(setupGroup);
    }

    // Smart text sizing for badge cells
    function smartFit(codeNode, labelNode) {
      const cell = codeNode.parentElement;
      const padding = 20;
      
      const maxWidth = cell.clientWidth - (padding * 2);
      const maxHeight = cell.clientHeight - (padding * 2);
      
      let codeSize = 0.12;
      let labelSize = 0.05;
      
      const codeLength = codeNode.textContent.length;
      if (codeLength === 0) {
        return;
      } else if (codeLength === 1) {
        codeSize = 0.15;
      } else if (codeLength > 3) {
        codeSize = 0.08;
        labelSize = 0.04;
      }
      
      codeNode.style.fontSize = `calc(var(--badge) * ${codeSize})`;
      labelNode.style.fontSize = `calc(var(--badge) * ${labelSize})`;
      
      if (codeLength > 4) {
        codeNode.style.wordBreak = 'break-all';
      }
      
      if (labelNode.textContent.length > 20) {
        labelNode.style.wordBreak = 'break-word';
      }
    }

    // Update badge display
    function updateBadge() {
      const role = [...document.querySelectorAll('#role-group input:checked')];
      const data = [...document.querySelectorAll('#data-group input:checked')];
      const method = [...document.querySelectorAll('#method-group input:checked')];
      const review = [...document.querySelectorAll('#review-group input:checked')];

      const cells = document.querySelectorAll('.cell');

      const roleCode = cells[0].querySelector('.code');
      const roleLabel = cells[0].querySelector('.label');
      roleCode.textContent = role.map(r => r.value).join('');
      roleLabel.textContent = role.length ?
        role.map(r => TAGS.role.find(t => t.code === r.value).label).join(' + ') : '';
      smartFit(roleCode, roleLabel);

      const dataCode = cells[1].querySelector('.code');
      const dataLabel = cells[1].querySelector('.label');
      dataCode.textContent = data.map(d => d.value).join('');
      dataLabel.textContent = data.length ?
        data.map(d => TAGS.data.find(t => t.code === d.value).label).join(' + ') : '';
      smartFit(dataCode, dataLabel);

      const methodCode = cells[2].querySelector('.code');
      const methodLabel = cells[2].querySelector('.label');
      methodCode.textContent = method.map(m => m.value).join('');
      methodLabel.textContent = method.length ?
        method.map(m => TAGS.method.find(t => t.code === m.value).label).join(' + ') : '';
      smartFit(methodCode, methodLabel);

      const reviewCode = cells[3].querySelector('.code');
      const reviewLabel = cells[3].querySelector('.label');
      reviewCode.textContent = review.map(r => r.value).join('');
      reviewLabel.textContent = review.length ?
        review.map(r => TAGS.review.find(t => t.code === r.value).label).join(' + ') : '';
      smartFit(reviewCode, reviewLabel);

      updateCitation();
    }

    // Update citation panels
    function updateCitation() {
      const role = [...document.querySelectorAll('#role-group input:checked')];
      const data = [...document.querySelectorAll('#data-group input:checked')];
      const method = [...document.querySelectorAll('#method-group input:checked')];
      const review = [...document.querySelectorAll('#review-group input:checked')];

      const traceCode = `${role.map(r => r.value).join('') || '_'}-${data.map(d => d.value).join('') || '_'}-${method.map(m => m.value).join('') || '_'}-${review.map(r => r.value).join('') || '_'}`;
      
      // Build natural language description
      const modelNames = selectedModels.map(m => m.name);
      let naturalText = `I used AI${modelNames.length ? ` (${modelNames.join(' + ')})` : ''} to `;
      
      if (role.length > 0) {
        const parts = role.map(r => {
          const tmpl = NL_TEMPLATES.role[r.value];
          if (!tmpl) return '';
          let str = `${tmpl.verb} ${tmpl.action}`;
          if (tmpl.prep) str += ` ${tmpl.prep}`;
          return str;
        }).filter(Boolean);
        if (parts.length === 1) {
          naturalText += parts[0];
        } else if (parts.length === 2) {
          naturalText += `${parts[0]} and ${parts[1]}`;
        } else {
          const last = parts.pop();
          naturalText += `${parts.join(', ')}, and ${last}`;
        }
      } else {
        naturalText += "assist with unspecified tasks";
      }
      
      if (data.length > 0) {
        const dataCodes = data.map(d => d.value).sort().join('');
        if (NL_TEMPLATES.data.combinations[dataCodes]) {
          naturalText += ` using ${NL_TEMPLATES.data.combinations[dataCodes]}`;
        } else if (data.length === 1 && NL_TEMPLATES.data.single[data[0].value]) {
          naturalText += ` using ${NL_TEMPLATES.data.single[data[0].value]}`;
        } else {
          const sources = data.map(d => NL_TEMPLATES.data.single[d.value] || d.value);
          if (sources.length === 2) {
            naturalText += ` using ${sources[0]} and ${sources[1]}`;
          } else {
            const last = sources.pop();
            naturalText += ` using ${sources.join(', ')}, and ${last}`;
          }
        }
      } else {
        naturalText += " using unspecified sources";
      }
      
      if (method.length > 0) {
        const parts = method.map(m => {
          const tmpl = NL_TEMPLATES.method[m.value];
          if (!tmpl) return '';
          return `${tmpl.desc}${tmpl.suffix ? ` ${tmpl.suffix}` : ''}`;
        }).filter(Boolean);
        naturalText += `, ${parts.join(', ')}`;
      } else {
        naturalText += ", using an unspecified approach";
      }
      
      naturalText += ". ";
      
      naturalText += "The output ";
      if (review.length > 0) {
        const reviewCodes = review.map(r => r.value).sort().join('');
        if (NL_TEMPLATES.review.combinations[reviewCodes]) {
          naturalText += NL_TEMPLATES.review.combinations[reviewCodes];
        } else if (review.length === 1 && NL_TEMPLATES.review.single[review[0].value]) {
          naturalText += NL_TEMPLATES.review.single[review[0].value];
        } else {
          const reviews = review.map(r => NL_TEMPLATES.review.single[r.value] || r.value);
          if (reviews.length === 1) {
            naturalText += reviews[0];
          } else if (reviews.length === 2) {
            naturalText += `${reviews[0].replace(/^(was |has been |underwent )/, '')} and ${reviews[1].replace(/^(was |has been |underwent )/, '')}`;
          } else {
            const lastReview = reviews.pop();
            naturalText += `underwent ${reviews.map(r => r.replace(/^(was |has been |underwent )/, '')).join(', ')}, and ${lastReview.replace(/^(was |has been |underwent )/, '')}`;
          }
        }
      } else {
        naturalText += "has not been reviewed";
      }
      
      naturalText += ".";

      // Formal citation
      let formal = `AI Disclosure (${new Date().toISOString().split('T')[0]})\nTRACE: ${traceCode}${modelNames.length ? ' via ' + modelNames.join(' + ') : ''}\n\n`;
      formal += `Role: ${role.length ? role.map(r => TAGS.role.find(t => t.code === r.value).label).join(', ') : 'Unspecified'}\n`;
      formal += `Data: ${data.length ? data.map(d => TAGS.data.find(t => t.code === d.value).label).join(', ') : 'Unspecified'}\n`;
      formal += `Method: ${method.length ? method.map(m => TAGS.method.find(t => t.code === m.value).label).join(', ') : 'Unspecified'}\n`;
      formal += `Review: ${review.length ? review.map(r => TAGS.review.find(t => t.code === r.value).label).join(', ') : 'None'}`;
      
      document.getElementById('tab-formal').textContent = formal;
      document.getElementById('tab-natural').textContent = naturalText;
    }

    // Load AI models via CORS proxy
    async function loadAIModels() {
      const refreshBtn = document.querySelector('.refresh-btn');
      
      try {
        refreshBtn.disabled = true;
        refreshBtn.textContent = '⏳ Loading...';
        
        const response = await fetch('https://corsproxy.io/?' + 
          encodeURIComponent('https://openrouter.ai/api/v1/models'));
        const data = await response.json();
        
        if (data.data) {
          aiModels = data.data;
          refreshBtn.textContent = `✅ ${aiModels.length} models`;
          
          setTimeout(() => {
            refreshBtn.textContent = '🔄 Reload';
            refreshBtn.disabled = false;
          }, 2000);
        }
      } catch (error) {
        console.error('Failed to load models:', error);
        
        // Fallback to local models
        aiModels = [
          {id: 'openai/gpt-4o', name: 'GPT-4o'},
          {id: 'openai/gpt-4-turbo', name: 'GPT-4 Turbo'},
          {id: 'openai/o1', name: 'OpenAI o1'},
          {id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet'},
          {id: 'google/gemini-pro-1.5', name: 'Gemini Pro 1.5'},
          {id: 'meta/llama-3.3-70b', name: 'Llama 3.3 70B'},
          {id: 'deepseek/deepseek-r1', name: 'DeepSeek R1'}
        ];
        
        refreshBtn.textContent = '❌ Using fallback';
        setTimeout(() => {
          refreshBtn.textContent = '🔄 Reload';
          refreshBtn.disabled = false;
        }, 2000);
      }
    }

    // Model search functionality
    function setupModelSearch() {
      const searchInput = document.querySelector('.model-search');
      const resultsDiv = document.querySelector('.search-results');
      
      if (!searchInput || !resultsDiv) return;
      
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchModels(e.target.value);
        }, 200);
      });
    }

    function searchModels(query) {
      const resultsDiv = document.querySelector('.search-results');
      
      if (!query || query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
      }
      
      const filtered = aiModels.filter(m => 
        m.name.toLowerCase().includes(query.toLowerCase()) ||
        m.id.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 10);
      
      resultsDiv.innerHTML = filtered.length ? filtered.map(model => `
        <div class="model-pill" onclick="selectModel({id:'${model.id}', name:'${model.name.replace(/'/g, "\\'")}'})">
          ${model.name}
        </div>
      `).join('') : '<div style="padding: 0.5rem; color: #64748b;">No models found</div>';
    }

    function selectModel(model) {
      if (selectedModels.find(m => m.id === model.id)) return;
      
      selectedModels.push(model);
      updateSelectedModelsDisplay();
      updateCitation();
      updateModelNameDisplay();
      
      const searchInput = document.querySelector('.model-search');
      if (searchInput) {
        searchInput.value = '';
        searchModels('');
      }
    }

    function updateSelectedModelsDisplay() {
      const container = document.getElementById('selected-models-container');
      const list = document.getElementById('selected-models-list');
      
      if (selectedModels.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      list.innerHTML = selectedModels.map(model => `
        <div class="selected-model-item">
          <span>${model.name}</span>
          <button class="remove-model-btn" onclick="removeModel('${model.id}')">Remove</button>
        </div>
      `).join('');
    }

    function removeModel(modelId) {
      selectedModels = selectedModels.filter(m => m.id !== modelId);
      updateSelectedModelsDisplay();
      updateCitation();
      updateModelNameDisplay();
    }

    function updateModelNameDisplay() {
      const modelDiv = document.getElementById('model-name');
      if (!modelDiv) return;
      modelDiv.textContent = selectedModels.map(m => m.name).join(' + ');
    }

    // Citation tab switching
    document.querySelectorAll('.citation-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.citation-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.citation-panel').forEach(p => p.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // Style toggles
    document.getElementById('show-tags').addEventListener('change', (e) => {
      document.getElementById('badge').classList.toggle('hidden-tags', !e.target.checked);
    });

    document.getElementById('grayscale-mode').addEventListener('change', (e) => {
      document.getElementById('badge').classList.toggle('grayscale', e.target.checked);
    });

    // Button actions
    async function downloadBadge() {
      const badgeWrapper = document.getElementById('badge-wrapper');
      const canvas = await html2canvas(badgeWrapper, {
        scale: 3,
        backgroundColor: null,
        height: badgeWrapper.offsetHeight + 30
      });
      
      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `trace-badge-${new Date().toISOString().split('T')[0]}.png`;
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function copyCitation() {
      const activePanel = document.querySelector('.citation-panel.active');
      navigator.clipboard.writeText(activePanel.textContent);
      
      // Visual feedback
      const btn = document.querySelector('.button.secondary');
      const originalText = btn.textContent;
      btn.textContent = '✓ Copied!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 2000);
    }

    // Initialize on load
    window.addEventListener('load', () => {
      initializeOptions();
      setupModelSearch();
      updateBadge();
      updateModelNameDisplay();
      loadAIModels(); // Auto-load models
    });
  </script>
</body>
</html>
