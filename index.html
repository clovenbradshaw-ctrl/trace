<!DOCTYPE html>
<html lang="en">
<head>
<<<<<<< codex/redesign-model-selection-system
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TRACE Badge Generator</title>
<link rel="icon" type="image/png" href="https://storage.googleapis.com/art_homelessness/android-chrome-192x192.png" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --badge: 360px;
    --edge: 10px;
  }

  body {
    font-family: system-ui, sans-serif;
    margin: 1rem;
    line-height: 1.4;
    background: #f8fafc;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  h2 { 
    font-size: 1.8rem; 
    margin: 0; 
    color: #1e293b; 
  }

  .main-content {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  /* ---------- Badge and Citation Wrapper ---------- */
  .badge-and-citation {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    order: 2;
  }

  /* ---------- Badge ---------- */
  .badge-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* ---------- Controls ---------- */
  .controls-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-width: 400px;
    max-width: 500px;
    overflow: hidden;
    word-wrap: break-word;
    order: 1;
  }

  .badge {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    width: var(--badge);
    height: var(--badge);
    border-radius: calc(var(--badge) * 0.12);
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 0 var(--edge) #cbd5e0 inset, 0 4px 12px rgba(0,0,0,0.1);
    background: #cbd5e0;
  }

  .cell {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: calc(var(--edge) * 1.8) calc(var(--edge) * 1.4);
    box-sizing: border-box;
    overflow: hidden;
  }

  /* Remove individual cell borders and use gap approach */
  .cell:nth-child(1) { 
    border-top-left-radius: calc(var(--badge) * 0.12 - var(--edge));
    margin-right: calc(var(--edge) / 2);
    margin-bottom: calc(var(--edge) / 2);
  }
  .cell:nth-child(2) { 
    border-top-right-radius: calc(var(--badge) * 0.12 - var(--edge));
    margin-left: calc(var(--edge) / 2);
    margin-bottom: calc(var(--edge) / 2);
  }
  .cell:nth-child(3) { 
    border-bottom-left-radius: calc(var(--badge) * 0.12 - var(--edge));
    margin-right: calc(var(--edge) / 2);
    margin-top: calc(var(--edge) / 2);
  }
  .cell:nth-child(4) { 
    border-bottom-right-radius: calc(var(--badge) * 0.12 - var(--edge));
    margin-left: calc(var(--edge) / 2);
    margin-top: calc(var(--edge) / 2);
  }

  .code  { 
    font-weight: 600; 
    line-height: 1.1;
    white-space: normal;
    max-width: 100%;
    margin-bottom: calc(var(--edge) * 0.8);
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    text-align: center;
  }

  .label {
    line-height: 1.0;
    white-space: normal;
    word-break: break-word;
    line-break: anywhere;
    hyphens: auto;
    overflow-wrap: break-word;
    max-width: 100%;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  #cell-role { background: #06b6d4; }
  #cell-data { background: #22c55e; }
  #cell-method { background: #f97316; }
  #cell-review { background: #8b5cf6; }

  /* Grayscale mode */
  .badge.grayscale #cell-role { background: #374151; }
  .badge.grayscale #cell-data { background: #6b7280; }
  .badge.grayscale #cell-method { background: #9ca3af; }
  .badge.grayscale #cell-review { background: #d1d5db; }

  .badge.grayscale {
    box-shadow: 0 0 0 var(--edge) #9ca3af inset, 0 4px 12px rgba(0,0,0,0.1);
    background: #9ca3af;
  }

  .badge-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .badge-models {
    background: #f8fafc;
    border-radius: 8px;
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
  }

  .badge-models-title {
    font-weight: 600;
    color: #374151;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
  }

  .badge-models-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .badge-model-item {
    font-size: 0.8rem;
    color: #6b7280;
    line-height: 1.3;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .badge-model-provider {
    font-weight: 500;
    color: #374151;
  }

  .ai-model-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .ai-model-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .ai-model-title {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .refresh-btn {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    color: #64748b;
    transition: all 0.2s;
  }

  .refresh-btn:hover {
    background: #e2e8f0;
    color: #475569;
  }

  .model-selector-v2 {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .model-tabs {
    display: flex;
    gap: 0.5rem;
  }

  .model-tabs .tab {
    padding: 0.25rem 0.5rem;
    border: none;
    background: #e2e8f0;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
  }

  .model-tabs .tab.active {
    background: #3b82f6;
    color: white;
  }

  .tab-panel {
    display: block;
  }

  .model-categories {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .model-category h4 {
    margin: 0;
    font-size: 0.85rem;
    color: #374151;
  }

  .frequent-section {
    margin-top: 0.5rem;
  }

  .search-results {
    margin-top: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
  }

  .search-result {
    padding: 0.25rem 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
  }

  .search-result:hover {
    background: #f1f5f9;
  }

  .search-result .model-id {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .model-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }

  .model-pill {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 20px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .model-pill:hover {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .model-pill.selected {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .model-pill.suggested {
    border-color: #10b981;
  }

  .model-pill .provider {
    opacity: 0.7;
    font-size: 0.75rem;
  }

  .model-pill .remove {
    margin-left: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .model-pill.selected:hover .remove {
    opacity: 1;
  }

  .selected-models {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .selected-models-header {
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
  }

  .selected-models-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .selected-model-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    max-width: 100%;
    overflow: hidden;
  }

  .model-item-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    flex: 1;
    min-width: 0;
    margin-right: 0.5rem;
  }

  .model-item-name {
    font-weight: 500;
    color: #111827;
    font-size: 0.85rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    line-height: 1.2;
  }

  .model-item-provider {
    color: #6b7280;
    font-size: 0.75rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .remove-model-btn {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
    border-radius: 4px;
    padding: 0.25rem;
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
  }

  .remove-model-btn:hover {
    background: #fecaca;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: #111827;
  }

  .modal-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    color: #6b7280;
    transition: all 0.2s;
  }

  .modal-close:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .modal-body {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
  }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  .wizard-intro p {
    color: #6b7280;
    margin: 0;
    line-height: 1.6;
  }

  .wizard-question {
    text-align: center;
  }

  .question-progress {
    background: #f3f4f6;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 1.5rem;
    display: inline-block;
  }

  .question-tag {
    background: #eff6ff;
    border: 1px solid #dbeafe;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    color: #1e40af;
  }

  .question-text {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 2rem;
    line-height: 1.6;
    font-style: italic;
  }

  .question-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .wizard-complete {
    text-align: center;
  }

  .complete-icon {
    width: 60px;
    height: 60px;
    background: #10b981;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto 1rem;
  }

  .wizard-complete h4 {
    color: #10b981;
    margin: 0 0 0.5rem;
    font-size: 1.25rem;
  }

  .wizard-complete p {
    color: #6b7280;
    margin: 0 0 1.5rem;
  }

  .selected-tags {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e2e8f0;
  }

  .selected-tag {
    display: inline-block;
    background: #3b82f6;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin: 0.25rem;
    font-weight: 500;
  }

  .loading {
    color: #6b7280;
    font-style: italic;
  }

  .toggle-section {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #64748b;
  }

  .controls { 
    display: grid; 
    grid-template-columns: 1fr 1fr;
    gap: 1rem; 
  }

  fieldset { 
    border: 1px solid #e2e8f0; 
    padding: 1rem; 
    border-radius: 8px; 
    background: #f8fafc;
    margin: 0;
  }

  legend { 
    padding: 0 0.5rem; 
    font-weight: 600; 
    color: #1e293b;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .help-btn {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #64748b;
    transition: all 0.2s;
    padding: 0;
  }

  .help-btn:hover {
    background: #e2e8f0;
    color: #475569;
    transform: scale(1.1);
  }

  label:not(.option-card) {
    display: flex;
    align-items: center;
    margin: 0.5rem 0;
    font-size: 0.9rem;
    color: #475569;
    cursor: pointer;
  }

  label:not(.option-card) input {
    margin-right: 0.5rem;
  }

  .option-cards {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .option-card {
    display: block;
    cursor: pointer;
    transition: all 0.2s;
  }

  .option-card input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .card-content {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem;
    background: white;
    transition: all 0.2s;
  }

  .option-card input:checked + .card-content {
    border-color: #3b82f6;
    background: #eff6ff;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .option-card input:disabled + .card-content {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f9fafb;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .card-content .code {
    background: #1e293b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .card-content .label {
    font-weight: 500;
    color: #1e293b;
  }

  .help-text {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.25rem;
    font-style: italic;
  }

  /* Citation Section */
  .citation-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin: 0;
  }

  .citation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .citation-title {
    font-weight: 600;
    color: #1e293b;
    font-size: 1rem;
  }

  .citation-content {
    background: #f1f5f9;
    border-radius: 8px;
    padding: 1rem;
    font-family: ui-monospace, SFMono-Regular, 'Cascade Code', monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #334155;
    border: 1px solid #e2e8f0;
    white-space: pre-line;
  }

  .button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    text-decoration: none;
  }

  .button:hover {
    background: #2563eb;
  }

  .button.secondary {
    background: #64748b;
  }

  .button.secondary:hover {
    background: #475569;
  }

  .button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .hidden-tags .label {
    display: none;
  }

  .model-info {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
    line-height: 1.3;
  }

  .status-message {
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }

  .status-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
  }

  .status-error {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }

  @media (max-width: 768px) {
    .main-content {
      flex-direction: column;
=======
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRACE Badge Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5kLrBP1ZiZsa1+lZeI7IuAvV38DSHLVYDBlnJrped1IovnEwlHGawEq+y3OC/YLXTr4a9L5xRngRlwe5VrA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root {
      --blue:#3b82f6;
      --green:#10b981;
      --yellow:#f59e0b;
      --red:#ef4444;
      --gray:#e5e7eb;
>>>>>>> main
    }
    body {
      font-family: system-ui, sans-serif;
      margin:0;
      background:#f8fafc;
      color:#334155;
    }
<<<<<<< codex/redesign-model-selection-system
    
    .controls-section {
      min-width: unset;
      max-width: unset;
      order: 2;
=======
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:1rem;
      background:white;
      border-bottom:1px solid var(--gray);
    }
    .header-title {
      margin:0;
      font-size:1.5rem;
>>>>>>> main
    }
    .subtitle {
      margin:0;
      font-size:0.9rem;
      color:#64748b;
    }
    .header-left { display:flex; flex-direction:column; }
    .help-btn {
      border:1px solid var(--gray);
      background:white;
      border-radius:50%;
      width:2rem; height:2rem;
      font-weight:bold;
      cursor:pointer;
    }
    .main-container {
      display:grid;
      grid-template-columns:minmax(300px,1fr) minmax(400px,1.5fr) minmax(300px,1fr);
      gap:1rem;
      max-width:1400px;
      margin:0 auto;
      padding:1rem;
    }
    .left-panel, .center-panel, .right-panel {background:white; padding:1rem; border:1px solid var(--gray); border-radius:8px;}
    fieldset {border:1px solid var(--gray); border-left-width:4px; border-radius:4px; margin-bottom:1rem;}
    legend {padding:0 0.5rem; font-weight:600;}
    .quadrant.role {border-left-color:var(--blue);} 
    .quadrant.data {border-left-color:var(--green);} 
    .quadrant.method {border-left-color:var(--yellow);} 
    .quadrant.review {border-left-color:var(--red);} 
    .options {display:flex; flex-direction:column; gap:0.5rem;}
    .selection-card {border:1px solid var(--gray); border-radius:6px;}
    .selection-card input {display:none;}
    .selection-card label {display:flex; gap:0.5rem; padding:0.5rem; cursor:pointer; align-items:center;}
    .selection-card .code {font-weight:bold; font-size:1.1rem; width:1.5rem; text-align:center;}
    .selection-card input:checked + label {border:2px solid var(--blue); background:#eff6ff;}
    .selection-card small {color:#64748b;}
    .badge {width:400px; height:400px; border-radius:50%; border:8px solid var(--gray); display:flex; align-items:center; justify-content:center; font-size:2rem; background:white; box-shadow:0 0 0 10px #f59e0b inset,0 4px 12px rgba(0,0,0,0.1); transition:box-shadow 0.3s; margin:0 auto;}
    .style-toggle {text-align:center; margin-top:1rem;}
    .legend {margin-top:1rem; font-size:0.85rem; line-height:1.4;}
    .legend div {margin-bottom:0.25rem;}
    .tabs {display:flex; border-bottom:1px solid var(--gray); margin-bottom:0.5rem;}
    .tab-button {flex:1; padding:0.5rem; background:none; border:none; cursor:pointer;}
    .tab-button.active {border-bottom:2px solid var(--blue); font-weight:600;}
    .tab-panel {display:none; border:1px solid var(--gray); border-top:none; padding:0.5rem; white-space:pre-wrap; min-height:120px;}
    .tab-panel.active {display:block;}
    .actions {display:flex; gap:0.5rem; margin-top:1rem; flex-wrap:wrap;}
    .button {display:inline-flex; gap:0.25rem; align-items:center; padding:0.5rem 1rem; border:none; border-radius:6px; background:var(--blue); color:white; cursor:pointer;}
    .button.secondary {background:#64748b;}
    @media (max-width:968px){
      .main-container {grid-template-columns:1fr; grid-template-rows:auto auto auto;}
      .center-panel{order:1;} .left-panel{order:2;} .right-panel{order:3;}
      .badge{width:300px; height:300px;}
    }
  </style>
</head>
<body>
<<<<<<< codex/redesign-model-selection-system
  <div class="header">
    <h2>TRACE Badge Generator</h2>
  </div>

  <div class="main-content">
    <div class="controls-section">
      <div class="ai-model-section">
        <div class="ai-model-header">
          <div class="ai-model-title">AI Models Used</div>
          <button class="refresh-btn" onclick="loadAIModels()" title="Refresh model list">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23,4 23,10 17,10"></polyline>
              <polyline points="1,20 1,14 7,14"></polyline>
              <path d="M20.49,9A9,9 0 0 0 5.64,5.64L1,10m22,4L18.36,18.36A9,9 0 0 1 3.51,15"></path>
            </svg>
            Refresh
          </button>
        </div>
        
        <div class="model-selector-v2">
          <div class="model-tabs">
            <button class="tab active" data-tab="recent">Recent</button>
            <button class="tab" data-tab="popular">Popular</button>
            <button class="tab" data-tab="search">Search</button>
          </div>

          <div class="tab-panel" id="recent-panel">
            <div class="model-pills"></div>
            <div class="frequent-section">
              <small>Most Used:</small>
              <div class="frequent-models"></div>
            </div>
          </div>

          <div class="tab-panel" id="popular-panel" style="display:none">
            <div class="model-categories"></div>
          </div>

          <div class="tab-panel" id="search-panel" style="display:none">
            <input type="text" class="model-search" placeholder="Type to search models..." autocomplete="off">
            <div class="search-results"></div>
          </div>
        </div>

        <div class="selected-models" id="selected-models-container" style="display: none;">
          <div class="selected-models-header">
            <span>Selected Models:</span>
          </div>
          <div class="selected-models-list" id="selected-models-list"></div>
        </div>
        
        <div id="model-status"></div>
      </div>

      <div class="toggle-section">
        <div class="toggle">
          <input type="checkbox" id="show-tags" checked>
          <label for="show-tags">Show tags on badge</label>
        </div>
        <div class="toggle">
          <input type="checkbox" id="grayscale-mode">
          <label for="grayscale-mode">Grayscale version</label>
        </div>
      </div>

      <div class="controls">
        <fieldset id="role-group">
          <legend>
            Role
            <button class="help-btn" onclick="openWizard('role')" title="Get help selecting role">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9,9a3,3 0 1,1 6,0c0,2-3,3-3,3"/>
                <line x1="12" y1="17" x2="12" y2="17" stroke-width="3"/>
              </svg>
            </button>
          </legend>
        </fieldset>
        <fieldset id="data-group">
          <legend>
            Data
            <button class="help-btn" onclick="openWizard('data')" title="Get help selecting data">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9,9a3,3 0 1,1 6,0c0,2-3,3-3,3"/>
                <line x1="12" y1="17" x2="12" y2="17" stroke-width="3"/>
              </svg>
            </button>
          </legend>
        </fieldset>
        <fieldset id="method-group">
          <legend>
            Method
            <button class="help-btn" onclick="openWizard('method')" title="Get help selecting method">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9,9a3,3 0 1,1 6,0c0,2-3,3-3,3"/>
                <line x1="12" y1="17" x2="12" y2="17" stroke-width="3"/>
              </svg>
            </button>
          </legend>
        </fieldset>
        <fieldset id="review-group">
          <legend>
            Review
            <button class="help-btn" onclick="openWizard('review')" title="Get help selecting review">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9,9a3,3 0 1,1 6,0c0,2-3,3-3,3"/>
                <line x1="12" y1="17" x2="12" y2="17" stroke-width="3"/>
              </svg>
            </button>
          </legend>
        </fieldset>
      </div>
    </div>

    <div class="badge-and-citation">
      <div class="badge-section">
        <div id="badge" class="badge">
          <div id="cell-role"   class="cell"><span class="code"></span><span class="label"></span></div>
          <div id="cell-data"   class="cell"><span class="code"></span><span class="label"></span></div>
          <div id="cell-method" class="cell"><span class="code"></span><span class="label"></span></div>
          <div id="cell-review" class="cell"><span class="code"></span><span class="label"></span></div>
=======
  <header class="header">
    <div class="header-left">
      <h1 class="header-title">TRACE Badge Generator</h1>
      <p class="subtitle">Generate and share transparency badges for AI-assisted work</p>
    </div>
    <button class="help-btn" title="Quick Start Guide">?</button>
  </header>
  <div class="main-container">
    <section class="left-panel">
      <fieldset class="quadrant role" id="role-group">
        <legend>Role</legend>
        <div class="options">
          <div class="selection-card">
            <input type="radio" id="role-assist" name="role" value="A">
            <label for="role-assist">
              <span class="code">A</span>
              <div class="text"><strong>Assist</strong><small> Clean up grammar & style</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="role-draft" name="role" value="D">
            <label for="role-draft">
              <span class="code">D</span>
              <div class="text"><strong>Draft</strong><small> Wrote first draft</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="role-synthesis" name="role" value="S">
            <label for="role-synthesis">
              <span class="code">S</span>
              <div class="text"><strong>Synthesis</strong><small> Combined sources</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="role-analysis" name="role" value="N">
            <label for="role-analysis">
              <span class="code">N</span>
              <div class="text"><strong>Analysis</strong><small> Explained patterns</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="role-exploratory" name="role" value="E">
            <label for="role-exploratory">
              <span class="code">E</span>
              <div class="text"><strong>Exploratory</strong><small> Experimental testing</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="role-creative" name="role" value="C">
            <label for="role-creative">
              <span class="code">C</span>
              <div class="text"><strong>Creative</strong><small> Generated new content</small></div>
            </label>
          </div>
>>>>>>> main
        </div>
      </fieldset>
      <fieldset class="quadrant data" id="data-group">
        <legend>Data</legend>
        <div class="options">
          <div class="selection-card">
            <input type="checkbox" id="data-public" value="P">
            <label for="data-public">
              <span class="code">P</span>
              <div class="text"><strong>Public</strong><small> Public or user provided</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="data-internal" value="I">
            <label for="data-internal">
              <span class="code">I</span>
              <div class="text"><strong>Internal</strong><small> Private sources</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="data-model" value="M">
            <label for="data-model">
              <span class="code">M</span>
              <div class="text"><strong>Model-only</strong><small> No external input</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="data-unclear" value="U">
            <label for="data-unclear">
              <span class="code">U</span>
              <div class="text"><strong>Unclear</strong><small> Source unknown</small></div>
            </label>
          </div>
        </div>
      </fieldset>
      <fieldset class="quadrant method" id="method-group">
        <legend>Method</legend>
        <div class="options">
          <div class="selection-card">
            <input type="radio" id="method-raw" name="method" value="R">
            <label for="method-raw">
              <span class="code">R</span>
              <div class="text"><strong>Raw</strong><small> First answer</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="method-guided" name="method" value="G">
            <label for="method-guided">
              <span class="code">G</span>
              <div class="text"><strong>Guided</strong><small> Step-by-step prompts</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="method-rewriter" name="method" value="W">
            <label for="method-rewriter">
              <span class="code">W</span>
              <div class="text"><strong>Rewriter</strong><small> Transformed text</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="radio" id="method-augmented" name="method" value="A">
            <label for="method-augmented">
              <span class="code">A</span>
              <div class="text"><strong>Augmented</strong><small> Used tools</small></div>
            </label>
          </div>
        </div>
      </fieldset>
      <fieldset class="quadrant review" id="review-group">
        <legend>Review</legend>
        <div class="options">
          <div class="selection-card">
            <input type="checkbox" id="review-unreviewed" value="U">
            <label for="review-unreviewed">
              <span class="code">U</span>
              <div class="text"><strong>Unreviewed</strong><small> Not checked</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="review-skimmed" value="S">
            <label for="review-skimmed">
              <span class="code">S</span>
              <div class="text"><strong>Skimmed</strong><small> Quick read</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="review-peer" value="P">
            <label for="review-peer">
              <span class="code">P</span>
              <div class="text"><strong>Peer</strong><small> Non-expert review</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="review-expert" value="E">
            <label for="review-expert">
              <span class="code">E</span>
              <div class="text"><strong>Expert</strong><small> Expert reviewed</small></div>
            </label>
          </div>
          <div class="selection-card">
            <input type="checkbox" id="review-ai-check" value="A">
            <label for="review-ai-check">
              <span class="code">A</span>
              <div class="text"><strong>AI Self-Check</strong><small> Self-reviewed</small></div>
              <div class="text"><strong>AI-Check</strong><small> Self-reviewed</small></div>
            </label>
          </div>
        </div>
      </fieldset>
    </section>
    <section class="center-panel">
      <div id="badge" class="badge">TRACE</div>
      <div class="style-toggle">
        <label><input type="radio" name="style" value="color" checked> Color</label>
        <label><input type="radio" name="style" value="grayscale"> Grayscale</label>
        <label><input type="radio" name="style" value="contrast"> High Contrast</label>
      </div>
      <div class="legend" id="legend"></div>
    </section>
    <section class="right-panel">
      <div class="tabs">
        <button class="tab-button active" data-tab="citation">Citation</button>
        <button class="tab-button" data-tab="natural">Natural Language</button>
        <button class="tab-button" data-tab="embed">Embed Code</button>
      </div>
      <div class="tab-content">
        <pre id="tab-citation" class="tab-panel active"></pre>
        <pre id="tab-natural" class="tab-panel"></pre>
        <pre id="tab-embed" class="tab-panel"></pre>
      </div>
      <div class="actions">
        <button class="button" id="download-btn" onclick="downloadBadge()">Download PNG</button>
        <button class="button" onclick="copyCurrent()">Copy Citation</button>
        <button class="button secondary" onclick="shareLink()">Share Link</button>
      </div>
    </section>
  </div>
  <script>
    const TAGS = {
      role:[
        {code:'A', label:'Assist', desc:'Clean up grammar & style'},
        {code:'D', label:'Draft', desc:'Wrote first draft'},
        {code:'S', label:'Synthesis', desc:'Combined sources'},
        {code:'N', label:'Analysis', desc:'Explained patterns'},
        {code:'E', label:'Exploratory', desc:'Experimental testing'},
        {code:'C', label:'Creative', desc:'Generated new content'}
      ],
      data:[
        {code:'P', label:'Public', desc:'Public or user provided'},
        {code:'I', label:'Internal', desc:'Private sources'},
        {code:'M', label:'Model-only', desc:'No external input'},
        {code:'U', label:'Unclear', desc:'Source unknown'}
      ],
      method:[
        {code:'R', label:'Raw', desc:'First answer'},
        {code:'G', label:'Guided', desc:'Step-by-step prompts'},
        {code:'W', label:'Rewriter', desc:'Transformed text'},
        {code:'A', label:'Augmented', desc:'Used tools'}
      ],
      review:[
        {code:'U', label:'Unreviewed', desc:'Not checked'},
        {code:'S', label:'Skimmed', desc:'Quick read'},
        {code:'P', label:'Peer', desc:'Non-expert review'},
        {code:'E', label:'Expert', desc:'Expert reviewed'},
        {code:'A', label:'AI Self-Check', desc:'Self-reviewed'}
        {code:'A', label:'AI-Check', desc:'Self-reviewed'}
      ]
    };

<<<<<<< codex/redesign-model-selection-system
    let aiModels = [];
    let selectedModels = [];
    let currentWizardSection = '';
    let modelSearch;

    const POPULAR_MODELS = {
      'Featured': [
        {id: 'openai/gpt-4o', name: 'GPT-4o', icon: 'ðŸŸ¢'},
        {id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5', icon: 'ðŸ”·'},
        {id: 'google/gemini-pro-1.5', name: 'Gemini Pro', icon: 'ðŸ”¶'},
        {id: 'openai/o1-preview', name: 'o1', icon: 'âš¡'}
      ],
      'Image': [
        {id: 'openai/dall-e-3', name: 'DALL-E 3', icon: 'ðŸŽ¨'},
        {id: 'midjourney/v6', name: 'Midjourney', icon: 'ðŸ–¼ï¸'},
        {id: 'stability/sdxl', name: 'Stable Diffusion', icon: 'ðŸŽ­'}
      ],
      'Open Source': [
        {id: 'meta/llama-3.1-405b', name: 'Llama 3.1', icon: 'ðŸ¦™'},
        {id: 'mistral/mixtral-8x7b', name: 'Mixtral', icon: 'ðŸŒŸ'}
      ]
    };

    class ModelMemory {
      constructor() {
        this.storage = window.localStorage;
        this.STORAGE_KEY = 'trace_models';
        this.MAX_RECENT = 8;
      }
      getModelHistory() {
        const data = JSON.parse(this.storage.getItem(this.STORAGE_KEY) || '{}');
        return {
          recent: data.recent || [],
          frequency: data.frequency || {},
          favorites: data.favorites || []
        };
      }
      addModel(model) {
        const data = this.getModelHistory();
        data.frequency[model.id] = (data.frequency[model.id] || 0) + 1;
        data.recent = data.recent.filter(m => m.id !== model.id);
        data.recent.unshift(model);
        data.recent = data.recent.slice(0, this.MAX_RECENT);
        this.storage.setItem(this.STORAGE_KEY, JSON.stringify(data));
      }
      getMostUsed(limit = 4) {
        const data = this.getModelHistory();
        return Object.entries(data.frequency)
          .sort(([,a],[,b]) => b - a)
          .slice(0, limit)
          .map(([id]) => data.recent.find(m => m.id === id))
          .filter(Boolean);
      }
    }
    const modelMemory = new ModelMemory();

    class ModelPresets {
      savePreset(name, models) {
        const presets = JSON.parse(localStorage.getItem('trace_presets') || '{}');
        presets[name] = { models: models, created: Date.now(), useCount: 0 };
        localStorage.setItem('trace_presets', JSON.stringify(presets));
      }
      loadPreset(name) {
        const presets = JSON.parse(localStorage.getItem('trace_presets') || '{}');
        if (presets[name]) {
          presets[name].useCount++;
          localStorage.setItem('trace_presets', JSON.stringify(presets));
          return presets[name].models;
        }
        return [];
      }
    }

    class ModelSearch {
      constructor(models) {
        this.models = models;
        this.searchInput = document.querySelector('.model-search');
        this.resultsDiv = document.querySelector('.search-results');
        this.initSearch();
        if (this.resultsDiv) {
          this.resultsDiv.addEventListener('click', (e) => {
            const res = e.target.closest('.search-result');
            if (!res) return;
            const id = res.dataset.id;
            const model = this.models.find(m => m.id === id);
            if (model) {
              handleModelSelect(model);
              this.clearResults();
              if (this.searchInput) this.searchInput.value = '';
            }
          });
        }
      }
      setModels(models) { this.models = models; }
      initSearch() {
        let debounceTimer;
        if (!this.searchInput) return;
        this.searchInput.addEventListener('input', (e) => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            this.search(e.target.value);
          }, 200);
        });
      }
      search(query) {
        if (query.length < 2) {
          this.clearResults();
          return;
        }
        const results = this.models.filter(m =>
          m.name.toLowerCase().includes(query.toLowerCase()) ||
          m.id.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 10);
        this.resultsDiv.innerHTML = results.map(model => `
          <div class="search-result" data-id="${model.id}">
            <div class="model-name">${this.highlightMatch(model.name, query)}</div>
            <div class="model-id">${this.highlightMatch(model.id, query)}</div>
          </div>
        `).join('');
      }
      highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
      }
      clearResults() {
        if (this.resultsDiv) this.resultsDiv.innerHTML = '';
      }
    }

    function getModelById(id) {
      return aiModels.find(m => m.id === id) ||
        Object.values(POPULAR_MODELS).flat().find(m => m.id === id) ||
        modelMemory.getModelHistory().recent.find(m => m.id === id);
    }

    function handleModelSelect(model) {
      if (!model || selectedModels.find(m => m.id === model.id)) return;
      selectedModels.push(model);
      modelMemory.addModel(model);
      updateSelectedModelsDisplay();
      updateCitation();
      renderRecentModels();
    }

    function renderRecentModels() {
      const history = modelMemory.getModelHistory();
      const pills = document.querySelector('#recent-panel .model-pills');
      const freq = document.querySelector('.frequent-models');
      if (pills) {
        pills.innerHTML = history.recent.map(m =>
          `<div class="model-pill recent-model" data-id="${m.id}">${m.icon || ''}<span>${m.name}</span></div>`
        ).join('');
      }
      if (freq) {
        const most = modelMemory.getMostUsed(3);
        freq.innerHTML = most.map(m =>
          `<div class="model-pill" data-id="${m.id}">${m.icon || ''}<span>${m.name}</span></div>`
        ).join('');
      }
    }

    function renderPopularModels() {
      const container = document.querySelector('.model-categories');
      if (!container) return;
      container.innerHTML = '';
      Object.entries(POPULAR_MODELS).forEach(([category, models]) => {
        const section = document.createElement('div');
        section.className = 'model-category';
        const heading = document.createElement('h4');
        heading.textContent = category;
        section.appendChild(heading);
        const pills = document.createElement('div');
        pills.className = 'model-pills';
        models.forEach(m => {
          const pill = document.createElement('div');
          pill.className = 'model-pill';
          pill.dataset.id = m.id;
          pill.innerHTML = `${m.icon}<span>${m.name}</span>`;
          pills.appendChild(pill);
        });
        section.appendChild(pills);
        container.appendChild(section);
      });
    }

    function setupTabs() {
      document.querySelectorAll('.model-tabs .tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.model-tabs .tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = 'none');
          const panel = document.getElementById(`${tab.dataset.tab}-panel`);
          if (panel) panel.style.display = 'block';
        });
      });
    }

    function highlightSuggestedModels(ids) {
      document.querySelectorAll('.model-pill').forEach(pill => {
        pill.classList.toggle('suggested', ids.includes(pill.dataset.id));
      });
    }

    function suggestModelsForRole(role) {
      const suggestions = {
        'A': ['openai/gpt-4o', 'anthropic/claude-3.5-sonnet'],
        'D': ['anthropic/claude-3.5-sonnet', 'openai/gpt-4o'],
        'S': ['openai/o1-preview', 'google/gemini-pro-1.5'],
        'N': ['openai/o1-preview', 'anthropic/claude-3.5-sonnet'],
        'E': ['openai/gpt-4o', 'meta/llama-3.1-405b'],
        'C': ['openai/dall-e-3', 'midjourney/v6', 'anthropic/claude-3.5-sonnet']
      };
      return suggestions[role] || [];
    }

    document.addEventListener('change', (e) => {
      if (e.target.name === 'role') {
        const suggested = suggestModelsForRole(e.target.value);
        highlightSuggestedModels(suggested);
      }
    });

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        const input = document.querySelector('.model-search');
        if (input) input.focus();
      }
      if (e.target.tagName !== 'INPUT' && e.key >= '1' && e.key <= '9') {
        const index = parseInt(e.key) - 1;
        const recentModels = document.querySelectorAll('.recent-model');
        if (recentModels[index]) recentModels[index].click();
      }
    });

    const selector = document.querySelector('.model-selector-v2');
    if (selector) {
      selector.addEventListener('click', (e) => {
        const pill = e.target.closest('.model-pill');
        if (!pill) return;
        const model = getModelById(pill.dataset.id);
        handleModelSelect(model);
      });
    }

    const WIZARD_DATA = {
      role: {
        title: 'What job did the AI do?',
        options: TAGS.role.map(t => ({
          code: t.code,
          label: t.label,
          description: t.question.replace('Did ', '').replace('?', '')
        }))
      },
      data: {
        title: 'What sources were given?',
        allowMultiple: true,
        options: TAGS.data.map(t => ({
          code: t.code,
          label: t.label,
          description: t.question.replace('Did ', '').replace('?', ''),
          exclusive: t.exclusive
        }))
      },
      method: {
        title: 'How was the AI used?',
        options: TAGS.method.map(t => ({
          code: t.code,
          label: t.label,
          description: t.question.replace('Did ', '').replace('?', '')
        }))
      },
      review: {
        title: 'How was the output reviewed?',
        allowMultiple: true,
        options: TAGS.review.map(t => ({
          code: t.code,
          label: t.label,
          description: t.question.replace('Did ', '').replace('?', '')
        }))
      }
    };

    Object.entries(TAGS).forEach(([group, arr]) => {
      const fieldset = document.getElementById(`${group}-group`);
      const legend = fieldset.querySelector('legend');
      fieldset.innerHTML = '';
      fieldset.appendChild(legend);

      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'option-cards';

      arr.forEach(tag => {
        let inputType = 'radio';
        let inputName = group;

        if (group === 'data' && !tag.exclusive) {
          inputType = 'checkbox';
          inputName = 'data-inclusive';
        } else if (group === 'review') {
          inputType = 'checkbox';
          inputName = 'review-multi';
        }

        const card = document.createElement('label');
        card.className = 'option-card';
        card.innerHTML = `
          <input type="${inputType}" name="${inputName}" value="${tag.code}" 
                 id="${group}-${tag.code}" ${tag.exclusive ? 'data-exclusive="true"' : ''}>
          <div class="card-content">
            <div class="card-header">
              <span class="code">${tag.code}</span>
              <span class="label">${tag.label}</span>
            </div>
            <div class="help-text">${tag.question}</div>
          </div>
        `;
        cardsContainer.appendChild(card);
      });

      fieldset.appendChild(cardsContainer);
    });

    document.getElementById('data-group').addEventListener('change', (e) => {
      const target = e.target;

      if (target.dataset.exclusive === 'true' && target.checked) {
        document.querySelectorAll('#data-group input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          cb.disabled = true;
        });
        document.querySelectorAll('#data-group input[data-exclusive="true"]').forEach(radio => {
          if (radio !== target) {
            radio.checked = false;
          }
          radio.disabled = false;
        });
      } else if (target.type === 'checkbox' && target.checked) {
        document.querySelectorAll('#data-group input[data-exclusive="true"]').forEach(radio => {
          radio.checked = false;
          radio.disabled = true;
        });
        document.querySelectorAll('#data-group input[type="checkbox"]').forEach(cb => {
          cb.disabled = false;
        });
      } else if (!document.querySelector('#data-group input:checked')) {
        document.querySelectorAll('#data-group input').forEach(input => {
          input.disabled = false;
        });
      }

      paint();
    });

    document.querySelector('.controls').addEventListener('change', (e) => {
      if (e.target.closest('#data-group')) return;
      paint();
    });

    // Tag toggle
    document.getElementById('show-tags').addEventListener('change', (e) => {
      const badge = document.getElementById('badge');
      if (e.target.checked) {
        badge.classList.remove('hidden-tags');
      } else {
        badge.classList.add('hidden-tags');
      }
    });

    // Grayscale toggle
    document.getElementById('grayscale-mode').addEventListener('change', (e) => {
      const badge = document.getElementById('badge');
      if (e.target.checked) {
        badge.classList.add('grayscale');
      } else {
        badge.classList.remove('grayscale');
      }
    });

    // Remove selected model
    function removeSelectedModel(modelId) {
      selectedModels = selectedModels.filter(m => m.id !== modelId);
      updateSelectedModelsDisplay();
      updateCitation();
    }

    // Make these functions global
    window.removeSelectedModel = removeSelectedModel;
    window.downloadBadge = downloadBadge;
    window.copyCitation = copyCitation;
    window.loadAIModels = loadAIModels;
    window.openWizard = openWizard;
    window.closeWizard = closeWizard;
    window.applyWizardStep = applyWizardStep;

    function openWizard(section) {
      currentWizardSection = section;
      document.getElementById('wizard-modal').style.display = 'flex';
      document.getElementById('wizard-title').textContent = `TRACE Helper: ${section.charAt(0).toUpperCase() + section.slice(1)}`;
      showWizardStep();
=======
    function updateBadge(){
      const role=document.querySelector('input[name="role"]:checked');
      const data=[...document.querySelectorAll('#data-group input:checked')];
      const method=document.querySelector('input[name="method"]:checked');
      const review=[...document.querySelectorAll('#review-group input:checked')];
      const traceCode=`${role?role.value:''}-${data.map(d=>d.value).join('')}-${method?method.value:''}-${review.map(r=>r.value).join('')}`;
      const badge=document.getElementById('badge');
      badge.textContent=traceCode||'TRACE';
      let trust=50;
      if(role&&role.value==='A') trust+=20;
      if(role&&role.value==='D') trust-=10;
      if(data.find(d=>d.value==='P')) trust+=10;
      if(data.find(d=>d.value==='I')) trust-=5;
      if(data.find(d=>d.value==='M')) trust+=5;
      if(data.find(d=>d.value==='U')) trust-=15;
      if(review.find(r=>r.value==='U')) trust-=30;
      if(review.find(r=>r.value==='E')) trust+=20;
      if(review.find(r=>r.value==='P')) trust+=10;
      if(review.find(r=>r.value==='A')) trust+=5;
      if(trust>=70) badge.style.boxShadow='0 0 0 10px var(--green) inset,0 4px 12px rgba(0,0,0,0.1)';
      else if(trust>=40) badge.style.boxShadow='0 0 0 10px var(--yellow) inset,0 4px 12px rgba(0,0,0,0.1)';
      else badge.style.boxShadow='0 0 0 10px var(--red) inset,0 4px 12px rgba(0,0,0,0.1)';
      updateOutputs(role,data,method,review,traceCode);
    }

    function updateOutputs(role,data,method,review,traceCode){
      const roleText=role?TAGS.role.find(t=>t.code===role.value).label.toLowerCase():'unspecified';
      const dataText=data.length?data.map(d=>TAGS.data.find(t=>t.code===d.value).label.toLowerCase()).join(' and '):'unspecified sources';
      const methodText=method?TAGS.method.find(t=>t.code===method.value).label.toLowerCase():'unspecified';
      const reviewText=review.length?review.map(r=>TAGS.review.find(t=>t.code===r.value).label.toLowerCase()).join(' and '):'unreviewed';
      const natural=`I used AI to ${roleText} with ${dataText} by ${methodText} approach, and the output was ${reviewText}.`;
      const formal=`AI Disclosure (${new Date().toISOString().split('T')[0]})\nTRACE: ${traceCode}\nRole: ${roleText} | Data: ${dataText} | Method: ${methodText} | Review: ${reviewText}`;
      const embed=`<img src="trace-badge.png" alt="TRACE badge ${traceCode}">`;
      document.getElementById('tab-natural').textContent=natural;
      document.getElementById('tab-citation').textContent=formal;
      document.getElementById('tab-embed').textContent=embed;
>>>>>>> main
    }

    function renderLegend(){
      const legend=document.getElementById('legend');
      legend.innerHTML='';
      ['role','data','method','review'].forEach(cat=>{
        TAGS[cat].forEach(t=>{
          const div=document.createElement('div');
          div.innerHTML=`<span class="code">${t.code}</span> - ${t.label}`;
          legend.appendChild(div);
        });
      });
    }

<<<<<<< codex/redesign-model-selection-system
    // Load AI models from OpenRouter API
    async function loadAIModels() {
      const status = document.getElementById('model-status');
      const refreshBtn = document.querySelector('.refresh-btn');
      try {
        refreshBtn.disabled = true;
        status.innerHTML = '<div class="status-message">Loading latest AI models...</div>';
        const response = await fetch('https://openrouter.ai/api/v1/models');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        aiModels = data.data || [];
        status.innerHTML = `<div class="status-message status-success">âœ“ Loaded ${aiModels.length} AI models</div>`;
        if (modelSearch) {
          modelSearch.setModels(aiModels);
        } else {
          modelSearch = new ModelSearch(aiModels);
        }
      } catch (error) {
        console.error('Failed to load AI models:', error);
        status.innerHTML = `<div class="status-message status-error">âš  Failed to load models: ${error.message}</div>`;
      } finally {
        refreshBtn.disabled = false;
        setTimeout(() => { status.innerHTML = ''; }, 3000);
      }
    }

    // Consistent sizing that starts with same H1 size regardless of content
    function smartFit(codeNode, labelNode) {
      const box = codeNode.parentElement;
      const edgeSize = 10;
      const padding = edgeSize * 1.8;
      
      const maxWidth = box.clientWidth - (padding * 2) - 12;
      const maxHeight = box.clientHeight - (padding * 2) - 12;
      
      // Enhanced word breaking for labels
      if (labelNode.innerHTML.includes('â€‘') || labelNode.innerHTML.includes('-')) {
        let content = labelNode.innerHTML;
        content = content.replace(/(\w+)[\-â€‘](\w+)/g, '$1-<wbr>$2');
        labelNode.innerHTML = content;
      }
      
      // CONSISTENT starting sizes - same for all codes regardless of content length
      // Start with larger size for single letters so they match multi-letter codes
      const codeLength = codeNode.textContent.length;
      let codeSize = codeLength <= 2 ? 0.45 : 0.32;  // Bigger start for single/double letters
      let labelSize = 0.12; 
      
      // Try single-line first
      codeNode.style.whiteSpace = 'nowrap';
      
      // Check if it fits with consistent sizing
      for (let i = 0; i < 15; i++) {
        codeNode.style.fontSize = `calc(var(--badge)*${codeSize})`;
        labelNode.style.fontSize = `calc(var(--badge)*${labelSize})`;
        
        codeNode.offsetHeight;
        labelNode.offsetHeight;
        
        const codeHeight = codeNode.scrollHeight;
        const labelHeight = labelNode.scrollHeight;
        const marginBetween = 8;
        const totalHeight = codeHeight + marginBetween + labelHeight;
        const maxWidthUsed = Math.max(codeNode.scrollWidth, labelNode.scrollWidth);
        
        if (totalHeight <= maxHeight && maxWidthUsed <= maxWidth) {
          break; // Fits perfectly!
        }
        
        // Only shrink if necessary
        codeSize *= 0.94;
        labelSize *= 0.94;
        
        if (codeSize < 0.16) {
          break;
        }
      }
      
      // If still doesn't fit, try wrapping codes
      if (codeSize < 0.18) {
        codeNode.style.whiteSpace = 'normal';
        
        const codeText = codeNode.textContent;
        if (codeText.length > 6) {
          const codes = codeText.split(',');
          if (codes.length > 4) {
            const midpoint = Math.ceil(codes.length / 2);
            codeNode.innerHTML = codes.slice(0, midpoint).join(',') + '<br>' + codes.slice(midpoint).join(',');
          }
        }
        
        // Reset to good sizes for wrapped version
        codeSize = 0.26;
        labelSize = 0.10;
        
        for (let i = 0; i < 20; i++) {
          codeNode.style.fontSize = `calc(var(--badge)*${codeSize})`;
          labelNode.style.fontSize = `calc(var(--badge)*${labelSize})`;
          
          codeNode.offsetHeight;
          labelNode.offsetHeight;
          
          const codeHeight = codeNode.scrollHeight;
          const labelHeight = labelNode.scrollHeight;
          const marginBetween = 8;
          const totalHeight = codeHeight + marginBetween + labelHeight;
          const maxWidthUsed = Math.max(codeNode.scrollWidth, labelNode.scrollWidth);
          
          if (totalHeight <= maxHeight && maxWidthUsed <= maxWidth) {
            break;
          }
          
          codeSize *= 0.94;
          labelSize *= 0.94;
          
          if (codeSize < 0.10) {
            codeSize = 0.10;
            labelSize = 0.04;
            break;
          }
        }
      }
      
      codeNode.style.fontSize = `calc(var(--badge)*${codeSize})`;
      labelNode.style.fontSize = `calc(var(--badge)*${labelSize})`;
=======
    function setupInputs(){
      document.querySelectorAll('input').forEach(el=>{
        el.addEventListener('change',()=>{updateBadge(); updateStyle();});
      });
>>>>>>> main
    }

    function updateStyle(){
      const style=document.querySelector('input[name="style"]:checked').value;
      const badge=document.getElementById('badge');
      if(style==='grayscale') badge.style.filter='grayscale(1)';
      else if(style==='contrast') badge.style.filter='contrast(2)';
      else badge.style.filter='none';
    }

    function switchTab(e){
      const tab=e.target.dataset.tab;
      document.querySelectorAll('.tab-button').forEach(btn=>btn.classList.toggle('active',btn.dataset.tab===tab));
      document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+tab));
    }

    function copyCurrent(){
      const text=document.querySelector('.tab-panel.active').textContent;
      navigator.clipboard.writeText(text);
    }

    function shareLink(){
      navigator.clipboard.writeText(location.href);
      alert('Link copied to clipboard');
    }

    async function downloadBadge(){
      const badge=document.getElementById('badge');
      const canvas=await html2canvas(badge,{scale:3,backgroundColor:null});
      canvas.toBlob(blob=>{
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download='trace-badge.png';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

<<<<<<< codex/redesign-model-selection-system
    async function downloadBadge() {
      const downloadBtn = document.getElementById('download-btn');
      const originalText = downloadBtn.innerHTML;
      
      try {
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="8,12 12,16 16,12"/><line x1="12" y1="8" x2="12" y2="16"/></svg>Generating...';
        
        const badge = document.getElementById('badge');
        
        // Create canvas with higher resolution for better quality
        const canvas = await html2canvas(badge, {
          scale: 3, // 3x resolution for crisp image
          backgroundColor: null, // Transparent background
          useCORS: true,
          allowTaint: true,
          width: badge.offsetWidth,
          height: badge.offsetHeight
        });
        
        // Convert to blob and download
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `trace-badge-${new Date().toISOString().split('T')[0]}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          downloadBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>Downloaded!';
          
          setTimeout(() => {
            downloadBtn.innerHTML = originalText;
            downloadBtn.disabled = false;
          }, 2000);
          
        }, 'image/png', 0.95);
        
      } catch (error) {
        console.error('Download failed:', error);
        downloadBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>Error';
        
        setTimeout(() => {
          downloadBtn.innerHTML = originalText;
          downloadBtn.disabled = false;
        }, 2000);
      }
    }

    // Initialize
    paint();
    renderPopularModels();
    renderRecentModels();
    setupTabs();
    loadAIModels();
    updateBadgeModelsDisplay();
=======
    document.querySelectorAll('.tab-button').forEach(btn=>btn.addEventListener('click',switchTab));
    renderLegend();
    setupInputs();
    updateBadge();
>>>>>>> main
  </script>
</body>
</html>
